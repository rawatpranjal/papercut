Caching
=======

Papercutter caches extraction results to speed up repeated queries. This is especially useful when working with the same document multiple times or when building indexes.

How Caching Works
-----------------

When you extract text, build an index, or read sections from a PDF, Papercutter:

1. Computes a hash of the PDF file
2. Checks if cached results exist for that hash
3. Returns cached data if available, or extracts fresh data and caches it

Cache location: ``~/.cache/papercutter/<pdf-hash>/``

Each PDF gets its own cache directory containing:

- ``index.json`` - Document structure index
- ``pages/`` - Extracted text by page range
- ``tables/`` - Cached table extractions
- ``figures/`` - Cached figure extractions

Checking Cache Status
---------------------

See if a PDF has cached data:

.. code-block:: bash

   papercutter cache-info paper.pdf

Example output:

.. code-block:: json

   {
     "file": "paper.pdf",
     "cached": true,
     "cache_path": "/Users/you/.cache/papercutter/a1b2c3d4e5f6",
     "has_index": true,
     "has_pages": true,
     "size_bytes": 125000
   }

If no cache exists:

.. code-block:: json

   {
     "file": "paper.pdf",
     "cached": false,
     "cache_path": null
   }

Clearing Cache
--------------

**Clear cache for a specific file:**

.. code-block:: bash

   papercutter clear-cache paper.pdf

Output:

.. code-block:: json

   {
     "success": true,
     "cleared": "paper.pdf",
     "cache_path": "/Users/you/.cache/papercutter/a1b2c3d4e5f6"
   }

**Clear all cached data:**

.. code-block:: bash

   papercutter clear-cache

Output:

.. code-block:: json

   {
     "success": true,
     "cleared": "all",
     "cache_dir": "/Users/you/.cache/papercutter"
   }

When to Clear Cache
-------------------

Clear the cache when:

1. **PDF was modified** - If you edit or replace a PDF file, clear its cache to get fresh extractions

2. **Extraction quality issues** - If you suspect corrupted cache data

3. **Disk space** - Clear old caches to free up space

4. **Testing** - When developing or debugging extraction logic

Forcing Fresh Extraction
------------------------

Instead of clearing cache, you can force fresh extraction with ``--force``:

.. code-block:: bash

   # Re-index without using cache
   papercutter index paper.pdf --force

Python API
----------

Using the cache programmatically:

.. code-block:: python

   from pathlib import Path
   from papercutter.cache import get_cache

   cache = get_cache()

   # Check cache info
   info = cache.cache_info(Path("paper.pdf"))
   print(f"Cached: {info['cached']}")
   print(f"Has index: {info.get('has_index', False)}")

   # Clear cache for specific file
   cache.clear(Path("paper.pdf"))

   # Clear all cache
   cache.clear()

Working with cached pages:

.. code-block:: python

   from pathlib import Path
   from papercutter.cache import get_cache

   cache = get_cache()
   pdf_path = Path("paper.pdf")

   # Check if pages are cached
   cached_text = cache.get_pages(pdf_path, start_page=1, end_page=5)

   if cached_text:
       print("Using cached text")
       text = cached_text
   else:
       # Extract and cache
       from papercutter.core.text import TextExtractor
       from papercutter.extractors.pdfplumber import PdfPlumberExtractor

       extractor = TextExtractor(PdfPlumberExtractor())
       text = extractor.extract(pdf_path, pages=[0, 1, 2, 3, 4])

       # Store in cache
       cache.set_pages(pdf_path, start_page=1, end_page=5, text=text)

Cache with Document Indexer
---------------------------

The ``DocumentIndexer`` automatically uses caching:

.. code-block:: python

   from pathlib import Path
   from papercutter.index import DocumentIndexer

   indexer = DocumentIndexer()

   # First call: extracts and caches
   doc_index = indexer.index(Path("paper.pdf"))
   print("First index built")

   # Second call: returns from cache (fast)
   doc_index = indexer.index(Path("paper.pdf"))
   print("Returned from cache")

   # Force fresh index
   doc_index = indexer.index(Path("paper.pdf"), force=True)
   print("Fresh index built")

   # Check if cached
   is_cached = indexer.cache.has_index(Path("paper.pdf"))
   print(f"Is cached: {is_cached}")

Tips
----

1. **Cache is content-based** - Moving or renaming a PDF doesn't invalidate its cache (same content = same hash)

2. **First run is slower** - Initial extraction takes time; subsequent queries are fast

3. **LLM features use cache** - Summarization and reports automatically use cached text when available

4. **Disk usage** - Monitor ``~/.cache/papercutter/`` size if processing many documents

5. **Portable caches** - Cache directories can be copied between machines (hash-based paths)
