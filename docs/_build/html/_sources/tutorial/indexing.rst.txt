Document Indexing
=================

Papercutter can analyze document structure to detect sections, chapters, figures, and tables. This enables section-aware text extraction and intelligent navigation of long documents.

Quick Document Info
-------------------

Get basic PDF metadata without building a full index:

.. code-block:: bash

   papercutter info paper.pdf

Example output:

.. code-block:: json

   {
     "success": true,
     "file": "paper.pdf",
     "pages": 24,
     "hash": "a1b2c3d4e5f6...",
     "metadata": {
       "title": "A Study of Machine Learning",
       "author": "Jane Doe"
     }
   }

Building a Document Index
-------------------------

Create a structural map of sections, figures, and tables:

.. code-block:: bash

   # Index a paper (auto-detects document type)
   papercutter index paper.pdf

   # Force document type for better detection
   papercutter index textbook.pdf --type book

   # Save index to file
   papercutter index paper.pdf -o index.json

   # Force re-indexing (ignore cache)
   papercutter index paper.pdf --force

The index includes:

- **Sections** - Detected section headings with page ranges
- **Figures** - Figure captions and locations
- **Tables** - Table captions and locations
- **References** - Bibliography section location

Example output:

.. code-block:: json

   {
     "success": true,
     "cached": false,
     "type": "paper",
     "pages": 24,
     "sections": [
       {"id": 1, "title": "Introduction", "pages": [1, 3]},
       {"id": 2, "title": "Related Work", "pages": [3, 5]},
       {"id": 3, "title": "Methods", "pages": [5, 10]},
       {"id": 4, "title": "Results", "pages": [10, 18]},
       {"id": 5, "title": "Conclusion", "pages": [18, 20]}
     ],
     "figures": [
       {"id": 1, "caption": "System Architecture", "page": 6},
       {"id": 2, "caption": "Performance Results", "page": 12}
     ],
     "tables": [
       {"id": 1, "caption": "Dataset Statistics", "page": 7}
     ]
   }

Chapter Detection
-----------------

For books and long documents, detect chapter boundaries:

.. code-block:: bash

   # List chapters
   papercutter chapters textbook.pdf

   # JSON output for scripting
   papercutter chapters textbook.pdf --json

Example output:

.. code-block:: json

   {
     "success": true,
     "file": "textbook.pdf",
     "count": 12,
     "chapters": [
       {"id": 1, "title": "Introduction to Economics", "pages": [1, 28], "page_count": 28},
       {"id": 2, "title": "Supply and Demand", "pages": [29, 56], "page_count": 28},
       {"id": 3, "title": "Market Equilibrium", "pages": [57, 82], "page_count": 26}
     ]
   }

Chapter detection uses:

1. **PDF bookmarks/outline** (if available) - Most reliable
2. **Text pattern detection** - Falls back to detecting "Chapter X" patterns

Section-Aware Reading
---------------------

The ``read`` command extracts text from specific parts of a document. This is more precise than page-based extraction because it uses the document structure.

**Read by page range:**

.. code-block:: bash

   # Single page
   papercutter read paper.pdf --pages 5

   # Page range
   papercutter read paper.pdf --pages 10-14

   # Multiple ranges
   papercutter read paper.pdf --pages 1-3,10-12,20

**Read by section name:**

.. code-block:: bash

   # Read the Methods section
   papercutter read paper.pdf --section "Methods"

   # Partial matching works
   papercutter read paper.pdf --section "method"

   # Read by section ID (from index)
   papercutter read paper.pdf --section 3

**Read by chapter (for books):**

.. code-block:: bash

   # Read chapter 5
   papercutter read textbook.pdf --chapter 5

**Read entire document:**

.. code-block:: bash

   papercutter read paper.pdf --all

Example output:

.. code-block:: json

   {
     "success": true,
     "file": "paper.pdf",
     "query": {
       "section": "Methods",
       "section_id": 3,
       "pages": [5, 10]
     },
     "content": {
       "text": "In this section, we describe our methodology...",
       "word_count": 2500,
       "char_count": 15000
     }
   }

Python API
----------

Using the indexer programmatically:

.. code-block:: python

   from pathlib import Path
   from papercutter.index import DocumentIndexer

   indexer = DocumentIndexer()

   # Build index
   doc_index = indexer.index(Path("paper.pdf"))

   # Access structure
   print(f"Document type: {doc_index.doc_type}")
   print(f"Pages: {doc_index.pages}")

   # Iterate sections
   for section in doc_index.sections:
       print(f"Section: {section.title} (pages {section.pages})")

   # Access figures and tables
   for fig in doc_index.figures:
       print(f"Figure {fig.id}: {fig.caption} on page {fig.page}")

Chapter detection:

.. code-block:: python

   from pathlib import Path
   from papercutter.books.splitter import ChapterSplitter

   splitter = ChapterSplitter()
   chapters = splitter.detect_chapters(Path("textbook.pdf"))

   for chapter in chapters:
       print(f"Chapter: {chapter.title}")
       print(f"  Pages: {chapter.start_page + 1} to {chapter.end_page}")
       print(f"  Length: {chapter.page_count} pages")

Section-aware text extraction:

.. code-block:: python

   from pathlib import Path
   from papercutter.index import DocumentIndexer
   from papercutter.core.text import TextExtractor
   from papercutter.extractors.pdfplumber import PdfPlumberExtractor

   # Build index
   indexer = DocumentIndexer()
   doc_index = indexer.index(Path("paper.pdf"))

   # Find a section
   methods_section = None
   for section in doc_index.sections:
       if "method" in section.title.lower():
           methods_section = section
           break

   if methods_section:
       # Extract text from those pages
       backend = PdfPlumberExtractor()
       text_extractor = TextExtractor(backend)

       # Convert 1-indexed page range to 0-indexed page list
       pages = list(range(methods_section.pages[0] - 1, methods_section.pages[1]))
       text = text_extractor.extract(Path("paper.pdf"), pages=pages)

       print(f"Methods section ({len(text)} characters):")
       print(text[:500])

Workflow Example
----------------

Complete analysis of a paper using indexing:

.. code-block:: python

   from pathlib import Path
   from papercutter.index import DocumentIndexer
   from papercutter.intelligence import Summarizer

   # 1. Index the document
   indexer = DocumentIndexer()
   doc_index = indexer.index(Path("paper.pdf"))

   print(f"Paper has {len(doc_index.sections)} sections:")
   for s in doc_index.sections:
       print(f"  - {s.title}")

   # 2. Summarize specific sections
   summarizer = Summarizer()

   if summarizer.is_available():
       # Find results section
       for section in doc_index.sections:
           if "result" in section.title.lower():
               # Summarize just that section
               summary = summarizer.summarize(
                   Path("paper.pdf"),
                   pages=list(range(section.pages[0] - 1, section.pages[1])),
                   focus="results"
               )
               print(f"\n=== {section.title} Summary ===")
               print(summary.content)
               break

Tips
----

1. **Use ``--type book``** for textbooks and long documents to enable chapter detection

2. **Cache is automatic** - Repeated index queries are fast because results are cached

3. **Section names are flexible** - Partial, case-insensitive matching works for ``--section``

4. **Combine with LLM features** - Use sections/chapters with ``papercutter study`` for targeted study aids

5. **JSON output for scripting** - Use ``--json`` flag for machine-readable output
